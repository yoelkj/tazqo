<!-- src/components/ScrollUI.astro --><!-- Barra de progreso full-width + botón GoTop --><!-- Barra de progreso (full width desde el borde izquierdo) -->
<div
  id="progressWrap"
  class="hidden fixed left-0 right-0 z-40 pointer-events-none"
>
  <div class="h-[3px] bg-slate-200/60 overflow-hidden">
    <div id="progressBar" class="h-full bg-brand-indigo" style="width:0%"></div>
  </div>
</div>

<!-- Go to top (oculto por defecto) -->
<button
  id="goTop"
  aria-label="Volver arriba"
  class="hidden fixed bottom-6 right-6 z-40
         h-12 w-12 rounded-full bg-white text-slate-700
         shadow-elev-2 ring-1 ring-slate-200
         hover:text-brand-indigo hover:ring-brand-indigo/40
         focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-indigo"
>
  <svg viewBox="0 0 24 24" class="mx-auto h-6 w-6" aria-hidden="true">
    <path fill="currentColor" d="M12 5l-7 7h4v7h6v-7h4z"></path>
  </svg>
</button>

<style is:inline>
  /* Ubicar la barra justo debajo del header fijo (usa var global si existe) */
  #progressWrap {
    top: calc(var(--header-h, 64px));
  }

  /* Ocultar GoTop cuando el menú móvil está abierto (evita superposición) */
  body.menu-open #goTop {
    display: none;
  }

  /* Suavizado del avance (respeta reduced motion) */
  #progressBar {
    transition: width 80ms linear;
  }
  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto !important;
    }
    #progressBar {
      transition: none !important;
    }
  }
</style>

<script is:inline>
  (() => {
    const wrap = document.getElementById("progressWrap");
    const bar = document.getElementById("progressBar");
    const btn = document.getElementById("goTop");

    if (!wrap || !bar || !btn) return;

    const SHOW_BAR_AFTER = 8; // px para empezar a mostrar la barra
    const SHOW_BTN_AFTER = 300; // px para mostrar el botón

    function updateUI() {
      const scrolled = window.scrollY || document.documentElement.scrollTop;
      const max = Math.max(
        1,
        document.documentElement.scrollHeight -
          document.documentElement.clientHeight
      );
      const pct = Math.min(100, Math.max(0, (scrolled / max) * 100));
      bar.style.width = pct + "%";

      // Mostrar/ocultar barra
      if (scrolled > SHOW_BAR_AFTER) wrap.classList.remove("hidden");
      else {
        wrap.classList.add("hidden");
        bar.style.width = "0%";
      }

      // Mostrar/ocultar botón
      if (scrolled > SHOW_BTN_AFTER) btn.classList.remove("hidden");
      else btn.classList.add("hidden");
    }

    // Scroll performante con rAF
    let ticking = false;
    window.addEventListener(
      "scroll",
      () => {
        if (!ticking) {
          requestAnimationFrame(() => {
            updateUI();
            ticking = false;
          });
          ticking = true;
        }
      },
      { passive: true }
    );

    // Click ir arriba
    btn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Estado inicial
    updateUI();
  })();
</script>
